{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Statistiques - Gestion Scolaire{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-bar me-2"></i>
        Statistiques et Analyses
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download me-1"></i>Exporter Rapport
            </button>
            <button type="button" class="btn btn-sm btn-outline-info">
                <i class="fas fa-print me-1"></i>Imprimer
            </button>
        </div>
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="period" id="month" autocomplete="off" checked>
            <label class="btn btn-outline-primary btn-sm" for="month">Ce mois</label>
            
            <input type="radio" class="btn-check" name="period" id="semester" autocomplete="off">
            <label class="btn btn-outline-primary btn-sm" for="semester">Semestre</label>
            
            <input type="radio" class="btn-check" name="period" id="year" autocomplete="off">
            <label class="btn btn-outline-primary btn-sm" for="year">Année</label>
        </div>
    </div>
</div>

<!-- Statistiques générales -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-white-50 small">Total Étudiants</div>
                    <div class="h2 mb-0 font-weight-bold">1,247</div>
                    <div class="text-white-50 small">
                        <i class="fas fa-arrow-up me-1"></i>+12% ce mois
                    </div>
                </div>
                <div class="fa-3x opacity-50">
                    <i class="fas fa-user-graduate"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-white-50 small">Moyenne Générale</div>
                    <div class="h2 mb-0 font-weight-bold">14.2/20</div>
                    <div class="text-white-50 small">
                        <i class="fas fa-arrow-up me-1"></i>+0.8 point
                    </div>
                </div>
                <div class="fa-3x opacity-50">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-white-50 small">Taux de Réussite</div>
                    <div class="h2 mb-0 font-weight-bold">87.3%</div>
                    <div class="text-white-50 small">
                        <i class="fas fa-arrow-up me-1"></i>+2.1%
                    </div>
                </div>
                <div class="fa-3x opacity-50">
                    <i class="fas fa-trophy"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-white-50 small">Cours Dispensés</div>
                    <div class="h2 mb-0 font-weight-bold">342</div>
                    <div class="text-white-50 small">
                        <i class="fas fa-calendar me-1"></i>Ce mois
                    </div>
                </div>
                <div class="fa-3x opacity-50">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Graphique des notes par mois -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-chart-area me-2"></i>Évolution des Moyennes par Mois
            </div>
            <div class="card-body">
                <canvas id="notesEvolutionChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Répartition par niveau -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>Répartition par Niveau
            </div>
            <div class="card-body">
                <canvas id="niveauChart"></canvas>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="d-flex align-items-center">
                            <span class="badge bg-primary me-2"></span>Licence 1
                        </span>
                        <span>35%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="d-flex align-items-center">
                            <span class="badge bg-success me-2"></span>Licence 2
                        </span>
                        <span>28%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="d-flex align-items-center">
                            <span class="badge bg-warning me-2"></span>Licence 3
                        </span>
                        <span>22%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="d-flex align-items-center">
                            <span class="badge bg-info me-2"></span>Master 1
                        </span>
                        <span>10%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="d-flex align-items-center">
                            <span class="badge bg-danger me-2"></span>Master 2
                        </span>
                        <span>5%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Statistiques par classe -->
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-users me-2"></i>Statistiques par Classe
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Classe</th>
                                <th>Étudiants</th>
                                <th>Moyenne</th>
                                <th>Taux Réussite</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in stats_classes %}
                            <tr>
                                <td>
                                    <strong>{{ stat.classe.nom }}</strong><br>
                                    <small class="text-muted">{{ stat.classe.get_niveau_display }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ stat.etudiants_count }}</span>
                                </td>
                                <td>
                                    <span class="{% if stat.moyenne_generale >= 10 %}text-success{% else %}text-danger{% endif %}">
                                        {{ stat.moyenne_generale }}/20
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress me-2" style="width: 60px; height: 8px;">
                                            <div class="progress-bar bg-success" style="width: 85%"></div>
                                        </div>
                                        <span class="small">85%</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistiques par matière -->
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-book me-2"></i>Performance par Matière
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Matière</th>
                                <th>Moyenne</th>
                                <th>Notes</th>
                                <th>Tendance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in stats_matieres %}
                            <tr>
                                <td>
                                    <strong>{{ stat.matiere.nom }}</strong><br>
                                    <small class="text-muted">{{ stat.matiere.code }}</small>
                                </td>
                                <td>
                                    <span class="{% if stat.moyenne >= 10 %}text-success{% else %}text-danger{% endif %}">
                                        {{ stat.moyenne }}/20
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ forloop.counter|mul:15 }}</span>
                                </td>
                                <td>
                                    {% if forloop.counter|divisibleby:2 %}
                                        <i class="fas fa-arrow-up text-success"></i>
                                    {% else %}
                                        <i class="fas fa-arrow-down text-danger"></i>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Graphiques supplémentaires -->
<div class="row">
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Distribution des Notes
            </div>
            <div class="card-body">
                <canvas id="distributionChart" height="150"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-calendar-alt me-2"></i>Assiduité par Mois
            </div>
            <div class="card-body">
                <canvas id="assiduitChart" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top performers -->
<div class="row">
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-medal me-2"></i>Top 10 Étudiants
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% with numbers="1,2,3,4,5,6,7,8,9,10"|split:"," %}
                    {% for i in numbers %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                {% if forloop.counter <= 3 %}
                                    <span class="badge bg-warning rounded-pill">{{ forloop.counter }}</span>
                                {% else %}
                                    <span class="badge bg-secondary rounded-pill">{{ forloop.counter }}</span>
                                {% endif %}
                            </div>
                            <div>
                                <h6 class="mb-0">Étudiant {{ forloop.counter }}</h6>
                                <small class="text-muted">L{{ forloop.counter|add:1 }}-INFO-A</small>
                            </div>
                        </div>
                        <span class="text-success fw-bold">{{ 20|sub:forloop.counter|add:2 }}.{{ forloop.counter }}0/20</span>
                    </div>
                    {% endfor %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-exclamation-triangle me-2"></i>Étudiants en Difficulté
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% with numbers2="1,2,3,4,5"|split:"," %}
                    {% for i in numbers2 %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-exclamation-circle text-danger"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">Étudiant Difficulté {{ forloop.counter }}</h6>
                                <small class="text-muted">L{{ forloop.counter }}-INFO-B</small>
                            </div>
                        </div>
                        <span class="text-danger fw-bold">{{ forloop.counter|add:5 }}.{{ forloop.counter }}0/20</span>
                    </div>
                    {% endfor %}
                    {% endwith %}
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-envelope me-1"></i>Contacter les familles
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: transform 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
}

.stats-card.success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.stats-card.warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stats-card.info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.progress {
    border-radius: 10px;
}

.list-group-item {
    border: none;
    border-bottom: 1px solid #e9ecef;
}

.list-group-item:last-child {
    border-bottom: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Graphique d'évolution des moyennes
const ctxEvolution = document.getElementById('notesEvolutionChart');
new Chart(ctxEvolution, {
    type: 'line',
    data: {
        labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'],
        datasets: [{
            label: 'Moyenne générale',
            data: [12.5, 13.1, 13.8, 14.2, 14.0, 14.5, 14.8, 14.3, 14.1, 14.2, 14.6, 14.9],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Objectif',
            data: [14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14],
            borderColor: '#e74c3c',
            borderDash: [5, 5],
            fill: false
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 20,
                ticks: {
                    callback: function(value) {
                        return value + '/20';
                    }
                }
            }
        }
    }
});

// Graphique de répartition par niveau
const ctxNiveau = document.getElementById('niveauChart');
new Chart(ctxNiveau, {
    type: 'doughnut',
    data: {
        labels: ['L1', 'L2', 'L3', 'M1', 'M2'],
        datasets: [{
            data: [35, 28, 22, 10, 5],
            backgroundColor: [
                '#667eea',
                '#27ae60',
                '#f39c12',
                '#3498db',
                '#e74c3c'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Graphique de distribution des notes
const ctxDistribution = document.getElementById('distributionChart');
new Chart(ctxDistribution, {
    type: 'bar',
    data: {
        labels: ['0-4', '4-8', '8-10', '10-12', '12-14', '14-16', '16-18', '18-20'],
        datasets: [{
            label: 'Nombre d\'étudiants',
            data: [12, 25, 45, 120, 180, 150, 80, 25],
            backgroundColor: [
                '#e74c3c', '#e67e22', '#f39c12', '#f1c40f',
                '#2ecc71', '#27ae60', '#16a085', '#1abc9c'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Graphique d'assiduité
const ctxAssiduite = document.getElementById('assiduitChart');
new Chart(ctxAssiduite, {
    type: 'line',
    data: {
        labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'],
        datasets: [{
            label: 'Taux de présence (%)',
            data: [92, 89, 94, 91, 88, 85, 82, 87, 93, 95, 91, 89],
            borderColor: '#27ae60',
            backgroundColor: 'rgba(39, 174, 96, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                min: 70,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
