{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Emploi du Temps - Gestion Scolaire{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-calendar-alt me-2"></i>
        Emploi du Temps
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-print me-1"></i>Imprimer
            </button>
            <button type="button" class="btn btn-sm btn-outline-info">
                <i class="fas fa-download me-1"></i>Exporter PDF
            </button>
        </div>
        <a href="{% url 'emploi_du_temps_list' %}" class="btn btn-sm btn-outline-info me-2">
            <i class="fas fa-list me-1"></i>Gestion
        </a>
        <a href="{% url 'ajouter_emploi_du_temps' %}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus me-1"></i>Ajouter Séance
        </a>
    </div>
</div>

<!-- Filtres -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label for="classe" class="form-label">Classe</label>
                <select class="form-select" id="classe" name="classe">
                    <option value="">Toutes les classes</option>
                    {% for classe in classes %}
                        <option value="{{ classe.id }}" {% if classe.id|stringformat:"s" == classe_id %}selected{% endif %}>
                            {{ classe.nom }} - {{ classe.get_niveau_display }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="enseignant" class="form-label">Enseignant</label>
                <select class="form-select" id="enseignant" name="enseignant">
                    <option value="">Tous les enseignants</option>
                    {% for enseignant in enseignants %}
                        <option value="{{ enseignant.id }}" {% if enseignant.id|stringformat:"s" == enseignant_id %}selected{% endif %}>
                            {{ enseignant.nom_complet }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="semaine" class="form-label">Semaine</label>
                <select class="form-select" id="semaine">
                    <option value="current">Cette semaine</option>
                    <option value="next">Semaine prochaine</option>
                    <option value="prev">Semaine précédente</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-1"></i>Filtrer
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Emploi du temps -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>
            <i class="fas fa-calendar-week me-2"></i>
            Semaine du 16 au 22 Octobre 2023
        </span>
        <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button type="button" class="btn btn-outline-primary">Aujourd'hui</button>
            <button type="button" class="btn btn-outline-secondary">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered mb-0 schedule-table">
                <thead class="table-dark">
                    <tr>
                        <th width="100" class="text-center">Heure</th>
                        <th class="text-center">
                            <div class="fw-bold">Lundi</div>
                            <small class="text-muted">16 Oct</small>
                        </th>
                        <th class="text-center">
                            <div class="fw-bold">Mardi</div>
                            <small class="text-muted">17 Oct</small>
                        </th>
                        <th class="text-center">
                            <div class="fw-bold">Mercredi</div>
                            <small class="text-muted">18 Oct</small>
                        </th>
                        <th class="text-center">
                            <div class="fw-bold">Jeudi</div>
                            <small class="text-muted">19 Oct</small>
                        </th>
                        <th class="text-center">
                            <div class="fw-bold">Vendredi</div>
                            <small class="text-muted">20 Oct</small>
                        </th>
                        <th class="text-center">
                            <div class="fw-bold">Samedi</div>
                            <small class="text-muted">21 Oct</small>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% with heures="08:00-09:00,09:00-10:00,10:00-11:00,11:00-12:00,12:00-13:00,13:00-14:00,14:00-15:00,15:00-16:00,16:00-17:00,17:00-18:00"|split:"," %}
                    {% for heure in heures %}
                    <tr>
                        <td class="text-center fw-bold bg-light time-slot">
                            {{ heure }}
                        </td>
                        {% with jours="LUNDI,MARDI,MERCREDI,JEUDI,VENDREDI,SAMEDI"|split:"," %}
                        {% for jour in jours %}
                        <td class="schedule-cell" data-jour="{{ jour }}" data-heure="{{ heure }}">
                            {% if forloop.first and forloop.parentloop.counter == 2 %}
                                <!-- Exemple de cours -->
                                <div class="course-block math">
                                    <div class="course-title">Mathématiques</div>
                                    <div class="course-details">
                                        <small>Prof. Dupont</small><br>
                                        <small><i class="fas fa-map-marker-alt"></i> Salle A101</small><br>
                                        <small><i class="fas fa-users"></i> L1-INFO-A</small>
                                    </div>
                                </div>
                            {% elif jour == "MARDI" and forloop.parentloop.counter == 3 %}
                                <div class="course-block info">
                                    <div class="course-title">Informatique</div>
                                    <div class="course-details">
                                        <small>Dr. Martin</small><br>
                                        <small><i class="fas fa-map-marker-alt"></i> Lab B205</small><br>
                                        <small><i class="fas fa-users"></i> L2-INFO-A</small>
                                    </div>
                                </div>
                            {% elif jour == "MERCREDI" and forloop.parentloop.counter == 4 %}
                                <div class="course-block physics">
                                    <div class="course-title">Physique</div>
                                    <div class="course-details">
                                        <small>Prof. Bernard</small><br>
                                        <small><i class="fas fa-map-marker-alt"></i> Amphi C</small><br>
                                        <small><i class="fas fa-users"></i> L1-PHYS</small>
                                    </div>
                                </div>
                            {% elif jour == "JEUDI" and forloop.parentloop.counter == 2 %}
                                <div class="course-block chemistry">
                                    <div class="course-title">Chimie</div>
                                    <div class="course-details">
                                        <small>Dr. Moreau</small><br>
                                        <small><i class="fas fa-map-marker-alt"></i> Lab D103</small><br>
                                        <small><i class="fas fa-users"></i> L1-CHEM</small>
                                    </div>
                                </div>
                            {% elif jour == "VENDREDI" and forloop.parentloop.counter == 5 %}
                                <div class="course-block english">
                                    <div class="course-title">Anglais</div>
                                    <div class="course-details">
                                        <small>Ms. Johnson</small><br>
                                        <small><i class="fas fa-map-marker-alt"></i> Salle E201</small><br>
                                        <small><i class="fas fa-users"></i> L2-ALL</small>
                                    </div>
                                </div>
                            {% else %}
                                <!-- Cellule vide -->
                                <div class="empty-slot">
                                    <button type="button" class="btn btn-outline-primary btn-sm add-course-btn" 
                                            data-jour="{{ jour }}" data-heure="{{ heure }}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                        {% endwith %}
                    </tr>
                    {% endfor %}
                    {% endwith %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Légende -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>Légende
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="d-flex align-items-center mb-2">
                            <div class="legend-color math me-2"></div>
                            <span>Mathématiques</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="legend-color info me-2"></div>
                            <span>Informatique</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="legend-color physics me-2"></div>
                            <span>Physique</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center mb-2">
                            <div class="legend-color chemistry me-2"></div>
                            <span>Chimie</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="legend-color english me-2"></div>
                            <span>Langues</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="legend-color sport me-2"></div>
                            <span>Sport</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Statistiques de la semaine
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <h4 class="text-primary">32</h4>
                        <small class="text-muted">Cours total</small>
                    </div>
                    <div class="col-4">
                        <h4 class="text-success">8</h4>
                        <small class="text-muted">Enseignants</small>
                    </div>
                    <div class="col-4">
                        <h4 class="text-warning">12</h4>
                        <small class="text-muted">Salles utilisées</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajouter Séance -->
<div class="modal fade" id="addScheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Ajouter une Séance
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cours_modal" class="form-label">Cours</label>
                                <select class="form-select" id="cours_modal" required>
                                    <option value="">Sélectionner un cours</option>
                                    <option value="1">Mathématiques - L1-INFO-A</option>
                                    <option value="2">Informatique - L2-INFO-A</option>
                                    <option value="3">Physique - L1-PHYS</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="type_cours" class="form-label">Type de cours</label>
                                <select class="form-select" id="type_cours" required>
                                    <option value="">Sélectionner</option>
                                    <option value="CM">Cours Magistral</option>
                                    <option value="TD">Travaux Dirigés</option>
                                    <option value="TP">Travaux Pratiques</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="jour_modal" class="form-label">Jour</label>
                                <select class="form-select" id="jour_modal" required>
                                    <option value="">Sélectionner</option>
                                    <option value="LUNDI">Lundi</option>
                                    <option value="MARDI">Mardi</option>
                                    <option value="MERCREDI">Mercredi</option>
                                    <option value="JEUDI">Jeudi</option>
                                    <option value="VENDREDI">Vendredi</option>
                                    <option value="SAMEDI">Samedi</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="heure_debut" class="form-label">Heure début</label>
                                <input type="time" class="form-control" id="heure_debut" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="heure_fin" class="form-label">Heure fin</label>
                                <input type="time" class="form-control" id="heure_fin" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="salle" class="form-label">Salle</label>
                        <input type="text" class="form-control" id="salle" placeholder="Ex: A101, Lab B205, Amphi C..." required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.schedule-table {
    font-size: 0.9rem;
}

.schedule-cell {
    height: 80px;
    vertical-align: top;
    padding: 4px;
    position: relative;
}

.time-slot {
    font-size: 0.8rem;
    line-height: 1.2;
}

.course-block {
    border-radius: 8px;
    padding: 8px;
    height: 100%;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 4px solid rgba(255,255,255,0.3);
}

.course-block:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.course-title {
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 4px;
}

.course-details {
    font-size: 0.75rem;
    line-height: 1.3;
}

.course-block.math {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.course-block.info {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.course-block.physics {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.course-block.chemistry {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.course-block.english {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.course-block.sport {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    color: #333;
}

.empty-slot {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.add-course-btn {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.schedule-cell:hover .add-course-btn {
    opacity: 1;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    display: inline-block;
}

.legend-color.math {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.legend-color.info {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.legend-color.physics {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.legend-color.chemistry {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.legend-color.english {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.legend-color.sport {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit pour les filtres
document.getElementById('classe').addEventListener('change', function() {
    this.form.submit();
});

document.getElementById('enseignant').addEventListener('change', function() {
    this.form.submit();
});

// Gestion des clics sur les boutons d'ajout de cours
document.querySelectorAll('.add-course-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const jour = this.dataset.jour;
        const heure = this.dataset.heure;
        
        // Pré-remplir le modal avec les données
        document.getElementById('jour_modal').value = jour;
        const heures = heure.split('-');
        document.getElementById('heure_debut').value = heures[0];
        document.getElementById('heure_fin').value = heures[1];
        
        // Ouvrir le modal
        const modal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
        modal.show();
    });
});

// Validation des heures
document.getElementById('heure_fin').addEventListener('change', function() {
    const debut = document.getElementById('heure_debut').value;
    const fin = this.value;
    
    if (debut && fin && fin <= debut) {
        alert('L\'heure de fin doit être postérieure à l\'heure de début');
        this.value = '';
    }
});

// Tooltip pour les cours
document.querySelectorAll('.course-block').forEach(block => {
    block.addEventListener('click', function() {
        // Afficher les détails du cours
        console.log('Cours cliqué:', this);
    });
});
</script>
{% endblock %}
